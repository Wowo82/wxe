name: IPTV

on:
  schedule:
    - cron: "0 * * * *"  # 每小时的0分执行（UTC时间）
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-and-upload-iptv:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: 检查环境依赖
        run: |
          echo "当前运行环境: $(uname -a)"
          which curl || (sudo apt update && sudo apt install -y curl)
          which sed || (sudo apt update && sudo apt install -y sed)

      - name: 下载原始iptv.m3u文件
        run: |
          curl -sSL "https://raw.githubusercontent.com/mursor1985/LIVE/refs/heads/main/iptv.m3u" -o iptv.m3u
          if [ -f "iptv.m3u" ]; then
            echo "✅ 原始文件下载成功，大小: $(du -h iptv.m3u)"
            head -n 10 iptv.m3u
          else
            echo "❌ 文件下载失败"
            exit 1
          fi

      - name: 处理文件（删除指定频道）
        run: |
          echo "🔧 开始处理文件..."
          # 删除group-title为指定分类的频道（含信息行和链接行）
          sed -i '/group-title="4K频道"/{N;d}' iptv.m3u
          sed -i '/group-title="其他"/{N;d}' iptv.m3u
          sed -i '/group-title="熊猫"/{N;d}' iptv.m3u
          sed -i '/group-title="印象天下"/{N;d}' iptv.m3u 
          sed -i '/group-title="纪实"/{N;d}' iptv.m3u
         
          # 删除包含cgtndoc-MCP和cgtn-MCP标识的频道（含信息行和链接行）
          sed -i '/cgtnar-MCP/{N;d}' iptv.m3u
          sed -i '/cgtndoc-MCP/{N;d}' iptv.m3u
          sed -i '/cgtn-MCP/{N;d}' iptv.m3u
          sed -i '/cgtnfr-MCP/{N;d}' iptv.m3u
          sed -i '/cgtnru-MCP/{N;d}' iptv.m3u
          sed -i '/cgtnsp-MCP/{N;d}' iptv.m3u
          echo "✅ 文件处理完成，处理后大小: $(du -h iptv.m3u)"
          head -n 10 iptv.m3u

      - name: 上传处理后的文件至凯速平台
        env:
          IPTV_FILE: "iptv.m3u"
        run: |
          set -euxo pipefail
          echo "📤 开始上传 $IPTV_FILE 至凯速平台"
          curl -sSf --retry 3 \
            -F "file=@$IPTV_FILE" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"
          echo "✅ 上传完成"
