name: IPTV

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-and-upload-iptv:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: æ£€æŸ¥ç¯å¢ƒä¾èµ–
        run: |
          echo "å½“å‰è¿è¡Œç¯å¢ƒ: $(uname -a)"
          # ç¡®ä¿curlå’Œsedå·²å®‰è£…
          which curl || (sudo apt update && sudo apt install -y curl)
          which sed || (sudo apt update && sudo apt install -y sed)

      - name: ä¸‹è½½åŸå§‹iptv.m3uæ–‡ä»¶
        run: |
          curl -sSL "https://raw.githubusercontent.com/mursor1985/LIVE/refs/heads/main/iptv.m3u" -o iptv.m3u
          if [ -f "iptv.m3u" ]; then
            echo "âœ… åŸå§‹æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h iptv.m3u)"
            head -n 10 iptv.m3u  # æ˜¾ç¤ºå‰10è¡Œç¡®è®¤æ ¼å¼
          else
            echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: å¤„ç†æ–‡ä»¶ï¼ˆä»…åˆ é™¤group-titleä¸º"4Ké¢‘é“"å’Œ"å…¶ä»–"çš„é¢‘é“ï¼‰
        run: |
          echo "ğŸ”§ å¼€å§‹å¤„ç†æ–‡ä»¶..."
          
          # åŸç†ï¼šIPTVé¢‘é“æ ¼å¼ä¸ºä¸¤è¡Œä¸€ç»„ï¼ˆ#EXTINFè¡Œ + é“¾æ¥è¡Œï¼‰
          # åŒ¹é…åŒ…å« group-title="4Ké¢‘é“" çš„#EXTINFè¡Œï¼ŒåŒæ—¶åˆ é™¤å…¶ä¸‹ä¸€è¡Œï¼ˆé“¾æ¥è¡Œï¼‰
          sed -i '/group-title="4Ké¢‘é“"/{N;d}' iptv.m3u
          
          # åŒæ ·åˆ é™¤ group-title="å…¶ä»–" çš„é¢‘é“ï¼ˆ#EXTINFè¡Œ + é“¾æ¥è¡Œï¼‰
          sed -i '/group-title="å…¶ä»–"/{N;d}' iptv.m3u
          
          # éªŒè¯å¤„ç†ç»“æœ
          echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¤„ç†åå¤§å°: $(du -h iptv.m3u)"
          echo "å¤„ç†åå‰10è¡Œå†…å®¹ï¼š"
          head -n 10 iptv.m3u

      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶è‡³å‡¯é€Ÿå¹³å°
        env:
          IPTV_FILE: "iptv.m3u"
        run: |
          set -euxo pipefail
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼  $IPTV_FILE è‡³å‡¯é€Ÿå¹³å°"
          curl -sSf --retry 3 \
            -F "file=@$IPTV_FILE" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"
          echo "âœ… ä¸Šä¼ å®Œæˆ"
        run: |
          echo "ğŸ”§ å¼€å§‹å¤„ç†æ–‡ä»¶..."
          
          # åˆ é™¤4Ké¢‘é“åˆ†ç±»ï¼ˆåŒ¹é…ä»¥#EXTGRP:4Ké¢‘é“å¼€å¤´çš„åˆ†ç»„ï¼ŒåŒ…å«å…¶ä¸‹æ‰€æœ‰é¢‘é“ï¼‰
          # åŸç†ï¼šä»#EXTGRP:4Ké¢‘é“å¼€å§‹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„ï¼ˆ#EXTGRP:ï¼‰å‰çš„å†…å®¹å…¨éƒ¨åˆ é™¤
          sed -i -e '/^#EXTGRP:4Ké¢‘é“/{:a' -e 'N;/^#EXTGRP:/!ba' -e 'd}' iptv.m3u
          
          # åˆ é™¤å…¶ä»–åˆ†ç±»ï¼ˆè¯·å°†"å…¶ä»–åˆ†ç±»åç§°"æ›¿æ¢ä¸ºå®é™…éœ€è¦åˆ é™¤çš„åˆ†ç±»ï¼Œå¦‚"æµ‹è¯•é¢‘é“"ã€"æ— ç”¨é¢‘é“"ç­‰ï¼‰
          # å¦‚éœ€åˆ é™¤å¤šä¸ªåˆ†ç±»ï¼Œå¤åˆ¶æ­¤è¡Œå¹¶ä¿®æ”¹åˆ†ç±»åç§°å³å¯
          sed -i -e '/^#EXTGRP:å…¶ä»–åˆ†ç±»åç§°/{:a' -e 'N;/^#EXTGRP:/!ba' -e 'd}' iptv.m3u
          
          # éªŒè¯å¤„ç†ç»“æœ
          echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¤„ç†åå¤§å°: $(du -h iptv.m3u)"
          # å¯é€‰ï¼šæ˜¾ç¤ºå¤„ç†åçš„å‰10è¡Œï¼Œç¡®è®¤åˆ†ç±»å·²åˆ é™¤
          head -n 10 iptv.m3u

      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶è‡³å‡¯é€Ÿå¹³å°
        env:
          IPTV_FILE: "iptv.m3u"  # å¤„ç†åçš„æ–‡ä»¶è·¯å¾„
        run: |
          set -euxo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šé”™è¯¯æ—¶é€€å‡ºå¹¶è¾“å‡ºè¯¦æƒ…
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼  $IPTV_FILE è‡³å‡¯é€Ÿå¹³å°"
          # æ‰§è¡Œä¸Šä¼ å‘½ä»¤ï¼ˆä½¿ç”¨ä»“åº“é…ç½®çš„å¯†é’¥ï¼‰
          curl -sSf --retry 3 \
            -F "file=@$IPTV_FILE" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"
          echo "âœ… ä¸Šä¼ å®Œæˆ"
