name: IPTV

# è§¦å‘æ¡ä»¶ï¼šæ¯å°æ—¶è¿è¡Œ + æ¨é€åˆ°mainåˆ†æ”¯ + æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: "0 * * * *"  # æ¯å°æ—¶çš„0åˆ†æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼Œè‹¥éœ€åŒ—äº¬æ—¶é—´éœ€+8å°æ—¶ï¼Œå¦‚"0 8-23 * * *"ä¸å¯¹ï¼Œç›´æ¥ç”¨UTCçš„0åˆ†å¯¹åº”åŒ—äº¬æ—¶é—´8ç‚¹ç­‰ï¼‰
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  process-and-upload-iptv:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: æ£€æŸ¥ç¯å¢ƒä¾èµ–
        run: |
          echo "å½“å‰è¿è¡Œç¯å¢ƒ: $(uname -a)"
          which curl || (sudo apt update && sudo apt install -y curl)
          which sed || (sudo apt update && sudo apt install -y sed)

      - name: ä¸‹è½½åŸå§‹iptv.m3uæ–‡ä»¶
        run: |
          curl -sSL "https://raw.githubusercontent.com/mursor1985/LIVE/refs/heads/main/iptv.m3u" -o iptv.m3u
          if [ -f "iptv.m3u" ]; then
            echo "âœ… åŸå§‹æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h iptv.m3u)"
            head -n 10 iptv.m3u
          else
            echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: å¤„ç†æ–‡ä»¶ï¼ˆä»…åˆ é™¤group-titleä¸º"4Ké¢‘é“"å’Œ"å…¶ä»–"çš„é¢‘é“ï¼‰
        run: |
          echo "ğŸ”§ å¼€å§‹å¤„ç†æ–‡ä»¶..."
          # åˆ é™¤group-title="4Ké¢‘é“"çš„é¢‘é“ï¼ˆå«ä¿¡æ¯è¡Œå’Œé“¾æ¥è¡Œï¼‰
          sed -i '/group-title="4Ké¢‘é“"/{N;d}' iptv.m3u
          # åˆ é™¤group-title="å…¶ä»–"çš„é¢‘é“ï¼ˆå«ä¿¡æ¯è¡Œå’Œé“¾æ¥è¡Œï¼‰
          sed -i '/group-title="å…¶ä»–"/{N;d}' iptv.m3u
          sed -i '/group-title="ç†ŠçŒ«"/{N;d}' iptv.m3u
          sed -i '/group-title="å°è±¡å¤©ä¸‹"/{N;d}' iptv.m3u          
          echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¤„ç†åå¤§å°: $(du -h iptv.m3u)"
          head -n 10 iptv.m3u

      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶è‡³å‡¯é€Ÿå¹³å°
        env:
          IPTV_FILE: "iptv.m3u"
        run: |
          set -euxo pipefail
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼  $IPTV_FILE è‡³å‡¯é€Ÿå¹³å°"
          curl -sSf --retry 3 \
            -F "file=@$IPTV_FILE" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"
          echo "âœ… ä¸Šä¼ å®Œæˆ"
