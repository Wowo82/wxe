name: IPTV

# è§¦å‘æ¡ä»¶ï¼šæ¯æ¬¡æ¨é€åˆ°mainåˆ†æ”¯æ—¶è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  process-and-upload-iptv:
    runs-on: ubuntu-latest
    environment: production  # å…³è”ç¯å¢ƒå˜é‡å’Œå¯†é’¥
    
    steps:
      - name: æ£€æŸ¥ç¯å¢ƒä¾èµ–
        run: |
          echo "å½“å‰è¿è¡Œç¯å¢ƒ: $(uname -a)"
          # ç¡®ä¿curlå’Œsedå·²å®‰è£…ï¼ˆsedç”¨äºå¤„ç†æ–‡ä»¶ï¼‰
          which curl || (sudo apt update && sudo apt install -y curl)
          which sed || (sudo apt update && sudo apt install -y sed)

      - name: ä¸‹è½½åŸå§‹iptv.m3uæ–‡ä»¶
        run: |
          # ä»ç›®æ ‡URLä¸‹è½½æ–‡ä»¶
          curl -sSL "https://raw.githubusercontent.com/mursor1985/LIVE/refs/heads/main/iptv.m3u" -o iptv.m3u
          # éªŒè¯ä¸‹è½½ç»“æœ
          if [ -f "iptv.m3u" ]; then
            echo "âœ… åŸå§‹æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h iptv.m3u)"
            # å¯é€‰ï¼šæ˜¾ç¤ºå‰10è¡Œç¡®è®¤æ ¼å¼
            head -n 10 iptv.m3u
          else
            echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: å¤„ç†æ–‡ä»¶ï¼ˆåˆ é™¤4Ké¢‘é“åŠå…¶ä»–åˆ†ç±»ï¼‰
        run: |
          echo "ğŸ”§ å¼€å§‹å¤„ç†æ–‡ä»¶..."
          
          # åˆ é™¤4Ké¢‘é“åˆ†ç±»ï¼ˆåŒ¹é…ä»¥#EXTGRP:4Ké¢‘é“å¼€å¤´çš„åˆ†ç»„ï¼ŒåŒ…å«å…¶ä¸‹æ‰€æœ‰é¢‘é“ï¼‰
          # åŸç†ï¼šä»#EXTGRP:4Ké¢‘é“å¼€å§‹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„ï¼ˆ#EXTGRP:ï¼‰å‰çš„å†…å®¹å…¨éƒ¨åˆ é™¤
          sed -i -e '/^#EXTGRP:4Ké¢‘é“/{:a' -e 'N;/^#EXTGRP:/!ba' -e 'd}' iptv.m3u
          
          # åˆ é™¤å…¶ä»–åˆ†ç±»ï¼ˆè¯·å°†"å…¶ä»–åˆ†ç±»åç§°"æ›¿æ¢ä¸ºå®é™…éœ€è¦åˆ é™¤çš„åˆ†ç±»ï¼Œå¦‚"æµ‹è¯•é¢‘é“"ã€"æ— ç”¨é¢‘é“"ç­‰ï¼‰
          # å¦‚éœ€åˆ é™¤å¤šä¸ªåˆ†ç±»ï¼Œå¤åˆ¶æ­¤è¡Œå¹¶ä¿®æ”¹åˆ†ç±»åç§°å³å¯
          sed -i -e '/^#EXTGRP:å…¶ä»–åˆ†ç±»åç§°/{:a' -e 'N;/^#EXTGRP:/!ba' -e 'd}' iptv.m3u
          
          # éªŒè¯å¤„ç†ç»“æœ
          echo "âœ… æ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¤„ç†åå¤§å°: $(du -h iptv.m3u)"
          # å¯é€‰ï¼šæ˜¾ç¤ºå¤„ç†åçš„å‰10è¡Œï¼Œç¡®è®¤åˆ†ç±»å·²åˆ é™¤
          head -n 10 iptv.m3u

      - name: ä¸Šä¼ å¤„ç†åçš„æ–‡ä»¶è‡³å‡¯é€Ÿå¹³å°
        env:
          IPTV_FILE: "iptv.m3u"  # å¤„ç†åçš„æ–‡ä»¶è·¯å¾„
        run: |
          set -euxo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šé”™è¯¯æ—¶é€€å‡ºå¹¶è¾“å‡ºè¯¦æƒ…
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼  $IPTV_FILE è‡³å‡¯é€Ÿå¹³å°"
          # æ‰§è¡Œä¸Šä¼ å‘½ä»¤ï¼ˆä½¿ç”¨ä»“åº“é…ç½®çš„å¯†é’¥ï¼‰
          curl -sSf --retry 3 \
            -F "file=@$IPTV_FILE" \
            "https://upload.kstore.space/upload/${{ secrets.KSTORE_ID }}?access_token=${{ secrets.KSTORE_TOKEN }}"
          echo "âœ… ä¸Šä¼ å®Œæˆ"
